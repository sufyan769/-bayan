<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>الموسوعة الشاملة - الرئيسية</title>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Noto+Naskh+Arabic:wght@400;700&display=swap"
    rel="stylesheet">

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <link rel="stylesheet" href="style.css">
</head>

<body>

  <!-- Unified Navigation -->
  <nav class="main-nav">
    <div class="nav-container">
      <a href="index.html" class="nav-logo">
        <i data-lucide="library"></i>
        <span>الموسوعة الشاملة</span>
      </a>
      <div class="nav-links">
        <a href="hadith.html" class="nav-link">
          <i data-lucide="book-open-check" class="w-4 h-4"></i>
          الحديث الشريف
        </a>
        <a href="scholars.html" class="nav-link">
          <i data-lucide="users" class="w-4 h-4"></i>
          تراجم العلماء
        </a>
        <a href="history.html" class="nav-link">
          <i data-lucide="scroll" class="w-4 h-4"></i>
          البداية والنهاية
        </a>
        <a href="algolia-search.html" class="nav-link">
          <i data-lucide="book" class="w-4 h-4"></i>
          موسوعة الفتاوى
        </a>
        <a href="firebase-search.html" class="nav-link">
          <i data-lucide="database" class="w-4 h-4"></i>
          بحث Firebase
        </a>
      </div>
    </div>
  </nav>

  <!-- Hero Section -->
  <div class="hero-section">
    <div class="container-fluid">
      <h1 class="hero-title">الموسوعة الإسلامية الشاملة</h1>
      <p class="hero-subtitle">منصة موحدة للبحث في الحديث الشريف، التاريخ الإسلامي، وتراجم العلماء.</p>

      <!-- Unified Search Section -->
      <div class="search-container">
        <div class="search-tabs">
          <button class="search-tab active" data-target="all">الكل</button>
          <button class="search-tab" data-target="hadith">الحديث</button>
          <button class="search-tab" data-target="history">التاريخ</button>
          <button class="search-tab" data-target="scholars">التراجم</button>
        </div>

        <form id="searchForm" class="search-input-wrapper">
          <button type="submit" class="search-btn">
            <i data-lucide="search" class="w-6 h-6"></i>
          </button>
          <input id="searchInput" type="text" class="search-input"
            placeholder="ابحث في الموسوعة (مثلاً: البخاري، عمر بن الخطاب)..." autocomplete="off">
        </form>
      </div>
    </div>
  </div>

  <div class="container-fluid">

    <!-- Loading State -->
    <div id="loadingState" class="hidden text-center py-12">
      <div class="w-10 h-10 border-4 border-[#3498db] border-t-transparent rounded-full animate-spin mx-auto"></div>
      <p class="text-lg text-gray-500 mt-4">جاري البحث في المصادر...</p>
    </div>

    <!-- No Results State -->
    <div id="noResultsState" class="hidden text-center py-12">
      <div class="bg-gray-50 rounded-lg p-8 max-w-lg mx-auto">
        <i data-lucide="search-x" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
        <p class="text-xl font-bold text-gray-700 mb-2">لم يتم العثور على نتائج</p>
        <p class="text-gray-500">حاول استخدام كلمات مختلفة أو تأكد من الإملاء.</p>
      </div>
    </div>

    <!-- Search Results -->
    <div id="resultsList" class="results-list hidden">
      <!-- Injected Items -->
    </div>

    <!-- Home dashboard sections removed as per user request -->
    <div id="homeDashboard"></div>
  </div>

  </div>
  <div class="card animate-pulse">
    <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
    <div class="h-4 bg-gray-200 rounded w-full mb-2"></div>
    <div class="h-4 bg-gray-200 rounded w-5/6"></div>
  </div>
  <div class="card animate-pulse">
    <div class="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
    <div class="h-4 bg-gray-200 rounded w-full mb-2"></div>
    <div class="h-4 bg-gray-200 rounded w-5/6"></div>
  </div>
  </div>
  </div>

  <!-- Footer -->
  <div class="text-center text-gray-400 text-sm py-10 border-t border-gray-200 mt-16">
    <p>&copy; 2025 الموسوعة الشاملة. جميع الحقوق محفوظة.</p>
  </div>

  </div>

  <!-- Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, query, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import algoliasearch from 'https://cdn.jsdelivr.net/npm/algoliasearch@4.22.1/dist/algoliasearch-lite.esm.browser.js';

    // --- Configuration ---
    const CONFIG = {
      hadith: {
        appId: '88G4AVERCC',
        apiKey: '76402a5d814264e01fb86ca687d26e30',
        indexName: 'firebase-hadeth',
        firebaseCollection: 'hadiths'
      },
      history: {
        appId: '88G4AVERCC',
        apiKey: '33b0b484f534b2ae2dac948d588345a6',
        indexName: 'algolia_unified'
      },
      scholars: {
        appId: '3XD12I7386',
        apiKey: '981ea91e88c65be8aadf2113c207b9c5',
        indexName: 'trajum'
      },
      firebase: {
        apiKey: "AIzaSyBYJ2pVoWJ5ednWOnnF2dOJ43MJvDi_8rw",
        authDomain: "hadeth-7baf7.firebaseapp.com",
        projectId: "hadeth-7baf7",
        storageBucket: "hadeth-7baf7.firebasestorage.app",
        messagingSenderId: "401684715520",
        appId: "1:401684715520:web:297abdb6aee1fb3176a0e5"
      }
    };

    // Initialize Firebase
    const app = initializeApp(CONFIG.firebase);
    const db = getFirestore(app);

    // Initialize Algolia Clients
    const clients = {
      hadith: algoliasearch(CONFIG.hadith.appId, CONFIG.hadith.apiKey).initIndex(CONFIG.hadith.indexName),
      history: algoliasearch(CONFIG.history.appId, CONFIG.history.apiKey).initIndex(CONFIG.history.indexName),
      scholars: algoliasearch(CONFIG.scholars.appId, CONFIG.scholars.apiKey).initIndex(CONFIG.scholars.indexName)
    };

    // DOM Elements
    const searchForm = document.getElementById('searchForm');
    const searchInput = document.getElementById('searchInput');
    const searchTabs = document.querySelectorAll('.search-tab');
    const resultsList = document.getElementById('resultsList');
    const homeDashboard = document.getElementById('homeDashboard');
    const loadingState = document.getElementById('loadingState');
    const noResultsState = document.getElementById('noResultsState');

    let currentTab = 'all';

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
      lucide.createIcons();
      // Featured content removed as per user request

      // Restore search state if available
      const lastResults = sessionStorage.getItem('lastSearchResults');
      const lastTerm = sessionStorage.getItem('lastSearchTerm');
      const lastTab = sessionStorage.getItem('lastActiveTab');

      if (lastResults && lastTerm) {
        // Restore input
        searchInput.value = lastTerm;

        // Restore tab
        if (lastTab) {
          searchTabs.forEach(t => {
            t.classList.remove('active');
            if (t.dataset.target === lastTab) {
              t.classList.add('active');
            }
          });
          currentTab = lastTab;
          const placeholders = {
            all: "ابحث في الموسوعة (مثلاً: البخاري، عمر بن الخطاب)...",
            hadith: "ابحث في الأحاديث (مثلاً: إنما الأعمال بالنيات)...",
            history: "ابحث في التاريخ (مثلاً: معركة بدر)...",
            scholars: "ابحث عن عالم (مثلاً: ابن تيمية)..."
          };
          if (placeholders[lastTab]) {
            searchInput.placeholder = placeholders[lastTab];
          }
        }

        // Restore UI
        homeDashboard.classList.add('hidden');
        loadingState.classList.add('hidden');
        noResultsState.classList.add('hidden');
        resultsList.classList.remove('hidden');

        // Render results
        try {
          const results = JSON.parse(lastResults);
          renderResults(results);
        } catch (e) {
          console.error("Error parsing saved results:", e);
          sessionStorage.removeItem('lastSearchResults');
        }
      }
    });
    // pageshow listener removed – allow browser back navigation to restore previous results

    // --- Tab Switching ---
    searchTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        searchTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentTab = tab.dataset.target;

        const placeholders = {
          all: "ابحث في الموسوعة (مثلاً: البخاري، عمر بن الخطاب)...",
          hadith: "ابحث في الأحاديث (مثلاً: إنما الأعمال بالنيات)...",
          history: "ابحث في التاريخ (مثلاً: معركة بدر)...",
          scholars: "ابحث عن عالم (مثلاً: ابن تيمية)..."
        };
        searchInput.placeholder = placeholders[currentTab];

        if (searchInput.value.trim()) {
          handleSearch(searchInput.value.trim());
        }
      });
    });

    // --- Search Logic ---
    searchForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const term = searchInput.value.trim();
      if (term) handleSearch(term);
    });

    async function handleSearch(term) {
      homeDashboard.classList.add('hidden');
      resultsList.innerHTML = '';
      resultsList.classList.add('hidden');
      noResultsState.classList.add('hidden');
      loadingState.classList.remove('hidden');

      try {
        let results = [];

        if (currentTab === 'all') {
          const [hadithRes, historyRes, scholarsRes] = await Promise.all([
            clients.hadith.search(term, { hitsPerPage: 5 }),
            clients.history.search(term, { hitsPerPage: 5 }),
            clients.scholars.search(term, { hitsPerPage: 5 })
          ]);

          const hydratedHadith = await hydrateHadithResults(hadithRes.hits);

          results = [
            ...formatResults(hydratedHadith, 'hadith'),
            ...formatResults(scholarsRes.hits, 'scholars'),
            ...formatResults(historyRes.hits, 'history')
          ];
        } else {
          const res = await clients[currentTab].search(term, { hitsPerPage: 20 });
          let hits = res.hits;
          if (currentTab === 'hadith') {
            hits = await hydrateHadithResults(hits);
          }
          results = formatResults(hits, currentTab);
        }

        loadingState.classList.add('hidden');

        if (results.length === 0) {
          noResultsState.classList.remove('hidden');
          // Clear saved results if no results found, but keep term/tab? 
          // Better to save empty state so it persists
          sessionStorage.setItem('lastSearchResults', JSON.stringify([]));
        } else {
          resultsList.classList.remove('hidden');
          renderResults(results);
          // Save state
          sessionStorage.setItem('lastSearchTerm', term);
          sessionStorage.setItem('lastActiveTab', currentTab);
          sessionStorage.setItem('lastSearchResults', JSON.stringify(results));
        }

      } catch (error) {
        console.error("Search Error:", error);
        loadingState.classList.add('hidden');
        resultsList.innerHTML = `<p class="text-center text-red-500">حدث خطأ أثناء البحث. يرجى المحاولة مرة أخرى.</p>`;
        resultsList.classList.remove('hidden');
      }
    }

    // --- Hydration Logic for Hadith ---
    async function hydrateHadithResults(hits) {
      const promises = hits.map(async (hit) => {
        try {
          const docRef = doc(db, CONFIG.hadith.firebaseCollection, hit.objectID);
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
            return { ...hit, ...docSnap.data() };
          }
          return hit;
        } catch (e) {
          console.error("Error hydrating hadith:", hit.objectID, e);
          return hit;
        }
      });
      return Promise.all(promises);
    }

    function formatResults(hits, type) {
      return hits.map(hit => {
        let title, snippet, link, meta;

        if (type === 'hadith') {
          title = hit.text ? hit.text.substring(0, 100) + "..." : "حديث شريف";
          snippet = hit.text || "";
          link = `details_hadith.html?id=${hit.objectID}`;

          let hukmBadge = '';
          if (hit.hukm) {
            const h = Array.isArray(hit.hukm) ? hit.hukm[0] : hit.hukm;
            let colorClass = 'badge-info';
            if (h.includes('صحيح')) colorClass = 'badge-success';
            if (h.includes('ضعيف') || h.includes('موضوع')) colorClass = 'badge-danger';
            hukmBadge = `<span class="badge ${colorClass}">${h}</span>`;
          }

          const source = hit.source ? (Array.isArray(hit.source) ? hit.source[0] : hit.source) : '';
          const rawi = hit.rawi ? (Array.isArray(hit.rawi) ? hit.rawi[0] : hit.rawi) : '';

          // Construct Meta with Narrator
          meta = `
            <div class="flex flex-wrap gap-2 items-center">
                ${hukmBadge}
                ${source ? `<span class="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded">${source}</span>` : ''}
                ${rawi ? `<span class="text-xs text-brown font-bold">الراوي: ${rawi}</span>` : ''}
            </div>
          `;

        } else if (type === 'scholars') {
          title = hit.name;
          snippet = hit.trj ? hit.trj.substring(0, 200) + "..." : "";
          link = `details_scholars.html?id=${hit.objectID}`;
          meta = `<span class="badge badge-info">تراجم</span> ${hit.death ? 'توفي: ' + hit.death : ''}`;
        } else if (type === 'history') {
          title = hit.name || "بدون عنوان";
          // Use full_intro or text for snippet
          const content = hit.full_intro || hit.text || "";
          snippet = content.substring(0, 200) + "...";
          link = `history.html?id=${hit.objectID}`;
          meta = `<span class="badge badge-warning">تاريخ</span>`;
        }

        return { type, title, snippet, link, meta, raw: hit };
      });
    }

    function renderResults(results) {
      results.forEach(item => {
        const div = document.createElement('div');
        div.className = 'result-item';
        div.innerHTML = `
          <div class="result-meta">${item.meta}</div>
          <h3 class="result-title">
            <a href="${item.link}">${item.title}</a>
          </h3>
          <div class="result-snippet">${item.snippet}</div>
        `;
        resultsList.appendChild(div);
      });
    }

    // --- Featured Content Logic ---
    // Featured Content Logic removed

  </script>
</body>

</html>
